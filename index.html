<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr-Inovates</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <img src="pic1.jpeg" alt="Dr-Inovates Logo" style="width: 100%; height: auto;">
        <nav>
            <ul>
                <li><a href="#home">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#services">Services</a></li>
                <li><a href="#contact">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="voice-recording">
            <h2>Voice Recording</h2>
            <button id="startRecord">Start Recording</button>
            <button id="stopRecord" disabled>Stop Recording</button>
            <button id="playRecord" disabled>Play Recording</button>
            <br><br>
            <audio id="audioPlayer" controls></audio>
            <div>
                <h3>Real-Time Transcript</h3>
                <textarea id="realTimeTranscript" rows="8" cols="80" readonly placeholder="Real-time transcript will appear here..."></textarea>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Dr-Inovates. All rights reserved.</p>
    </footer>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.947.0.min.js"></script>
    <script>
        AWS.config.region = 'ap-southeast-2';
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'ap-southeast-2:e1961e14-083d-4200-bb2b-c869a5ffbc3d'
        });

        const s3 = new AWS.S3();
        const startRecordBtn = document.getElementById('startRecord');
        const stopRecordBtn = document.getElementById('stopRecord');
        const playRecordBtn = document.getElementById('playRecord');
        const audioPlayer = document.getElementById('audioPlayer');
        const transcriptBox = document.getElementById('realTimeTranscript');
        let mediaRecorder, audioChunks = [], stream;
        let transcribeSocket;

        startRecordBtn.addEventListener('click', async () => {
            audioChunks = [];
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                audioPlayer.src = URL.createObjectURL(audioBlob);
                uploadAudioToS3(audioBlob);
                stopTranscription();
            };

            startTranscription(stream);
            mediaRecorder.start();
            startRecordBtn.disabled = true;
            stopRecordBtn.disabled = false;
            playRecordBtn.disabled = true;
        });

        stopRecordBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            stream.getTracks().forEach(track => track.stop());
            startRecordBtn.disabled = false;
            stopRecordBtn.disabled = true;
            playRecordBtn.disabled = false;
        });

        playRecordBtn.addEventListener('click', () => audioPlayer.play());

        function uploadAudioToS3(audioBlob) {
            const params = {
                Bucket: 'pm-chatgpt-test',
                Key: 'audio/latest-recording.wav',
                Body: audioBlob,
                ContentType: 'audio/wav',
            };

            s3.upload(params, function(err, data) {
                if (err) console.log('Error uploading:', err);
                else console.log('Uploaded:', data);
            });
        }

        async function startTranscription(stream) {
            const credentials = await AWS.config.credentials.getPromise();
            const accessKeyId = AWS.config.credentials.accessKeyId;
            const secretAccessKey = AWS.config.credentials.secretAccessKey;
            const sessionToken = AWS.config.credentials.sessionToken;

            const endpoint = `wss://transcribestreaming.${AWS.config.region}.amazonaws.com:8443/stream-transcription-websocket?language-code=en-US&media-encoding=pcm&sample-rate=44100&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=${encodeURIComponent(accessKeyId + '/' + AWS.util.date.iso8601(new Date()).substring(0, 10) + '/' + AWS.config.region + '/transcribe/aws4_request')}&X-Amz-Date=${AWS.util.date.iso8601(new Date()).replace(/[:-]|\.\d{3}/g, '')}&X-Amz-Security-Token=${encodeURIComponent(sessionToken)}`;

            transcribeSocket = new WebSocket(endpoint);
            transcribeSocket.binaryType = 'arraybuffer';
            transcribeSocket.onopen = () => {
                const audioCtx = new AudioContext();
                const input = audioCtx.createMediaStreamSource(stream);
                const processor = audioCtx.createScriptProcessor(4096, 1, 1);
                processor.onaudioprocess = e => {
                    const inputData = e.inputBuffer.getChannelData(0);
                    const pcmEncoded = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        pcmEncoded[i] = inputData[i] * 32767;
                    }
                    transcribeSocket.send(pcmEncoded.buffer);
                };
                input.connect(processor);
                processor.connect(audioCtx.destination);
            };

            transcribeSocket.onmessage = event => {
                const message = JSON.parse(new TextDecoder('utf-8').decode(event.data));
                const results = message.Transcript.Results;
                if (results && results.length > 0 && results[0].Alternatives.length > 0) {
                    const transcript = results[0].Alternatives[0].Transcript;
                    if (!results[0].IsPartial) {
                        transcriptBox.value += transcript + '\n';
                    }
                }
            };
        }

        function stopTranscription() {
            if (transcribeSocket && transcribeSocket.readyState === WebSocket.OPEN) {
                transcribeSocket.close();
            }
        }
    </script>
</body>
</html>
